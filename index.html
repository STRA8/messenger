<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>P2P Chat Room Simple</title>
<style>
body { font-family: sans-serif; margin: 20px; }
#chat { border: 1px solid #ccc; height: 350px; overflow-y: auto; padding: 10px; margin-bottom: 10px; background: #f9f9f9; }
input, button { margin: 5px 0; width: 100%; }
.message { margin: 2px 0; }
.system { color: green; font-weight: bold; }
.sender { color: blue; }
.receiver { color: darkorange; }
.debug { color: purple; font-style: italic; }
</style>
</head>
<body>

<h2>P2P Chat Room Simple</h2>

<label>Username: <input type="text" id="username"></label>
<label>Room ID: <input type="text" id="room"></label>
<input type="text" id="message" placeholder="Type your message">
<button id="sendBtn">Send</button>

<div id="chat"></div>

<script>
const workerUrl = "https://sparkling-wildflower-9369.devguywastaken.workers.dev/";
const chatDiv = document.getElementById("chat");
const usernameInput = document.getElementById("username");
const roomInput = document.getElementById("room");
const msgInput = document.getElementById("message");
const sendBtn = document.getElementById("sendBtn");

let pc, dc, connected=false, role=null;

function append(msg, cls="message") {
    const p=document.createElement("p");
    p.textContent=msg;
    p.className=cls;
    chatDiv.appendChild(p);
    chatDiv.scrollTop=chatDiv.scrollHeight;
}

async function sendSignal(room, data) {
    try { await fetch(workerUrl+"?id="+room, {method:"POST", body:JSON.stringify(data)}); }
    catch(e){ append("Signal send failed: "+e,"system"); }
}

async function pollSignal(room, username, handler) {
    while(!connected) {
        try {
            const res=await fetch(workerUrl+"?id="+room);
            const text=await res.text();
            let msgs=[];
            try{ msgs=JSON.parse(text); }catch(e){ append("Worker JSON parse failed","system"); await new Promise(r=>setTimeout(r,1000)); continue; }
            for(const m of msgs) if(m.from!==username) handler(m);
        } catch(e){ append("Polling error: "+e,"system"); }
        await new Promise(r=>setTimeout(r,1000));
    }
}

async function startConnection() {
    const username=usernameInput.value.trim();
    const room=roomInput.value.trim();
    if(!username||!room) { append("Enter username and room","system"); return; }
    if(pc) return;

    pc=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]});
    pc.oniceconnectionstatechange=()=>append("ICE state: "+pc.iceConnectionState,"debug");
    pc.onconnectionstatechange=()=>append("Connection state: "+pc.connectionState,"debug");
    pc.onsignalingstatechange=()=>append("Signaling state: "+pc.signalingState,"debug");

    let offerSet=false;

    // DataChannel setup
    if(!role) role="host"; // first person defaults to host
    if(role==="host") {
        dc=pc.createDataChannel("chat");
        dc.onopen=()=>{ append("✅ DataChannel open as host","system"); connected=true; };
        dc.onmessage=e=>append(e.data,"receiver");
    } else {
        pc.ondatachannel=e=>{ dc=e.channel; dc.onopen=()=>{ append("✅ DataChannel open as guest","system"); connected=true; }; dc.onmessage=e=>append(e.data,"receiver"); };
    }

    pc.onicecandidate=e=>{ if(e.candidate) sendSignal(room,{ice:e.candidate,from:username}); };

    if(role==="host") {
        const offer=await pc.createOffer();
        await pc.setLocalDescription(offer);
        offerSet=true;
        append("Host: SDP offer created","debug");
        await sendSignal(room,{sdp:offer,from:username});
    }

    pollSignal(room,username,async msg=>{
        if(msg.sdp) {
            if(!pc.currentRemoteDescription) {
                await pc.setRemoteDescription(new RTCSessionDescription(msg.sdp));
                append("Remote SDP set: "+msg.sdp.type,"system");
                if(msg.sdp.type==="offer" && role!=="host") {
                    const answer=await pc.createAnswer();
                    await pc.setLocalDescription(answer);
                    append("Guest: SDP answer created and sent","debug");
                    await sendSignal(room,{sdp:answer,from:username});
                }
            }
        }
        if(msg.ice) {
            try{ await pc.addIceCandidate(new RTCIceCandidate(msg.ice)); append("ICE candidate added","debug"); } 
            catch(e){ append("Error adding ICE: "+e,"system"); }
        }
    });
}

sendBtn.onclick=()=>{
    const msg=msgInput.value.trim();
    if(!msg||!dc||dc.readyState!=="open") { append("Cannot send: DataChannel not open","system"); return; }
    dc.send(usernameInput.value+": "+msg);
    append("You: "+msg,"sender");
    msgInput.value="";
}

usernameInput.addEventListener("change",startConnection);
roomInput.addEventListener("change",startConnection);
</script>

</body>
</html>
