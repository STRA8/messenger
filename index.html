<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>P2P Chat Room</title>
<style>
body { font-family: sans-serif; margin: 20px; }
#chat { border: 1px solid #ccc; height: 250px; overflow-y: auto; padding: 10px; margin-bottom: 10px; }
input, button { margin: 5px 0; width: 100%; }
</style>
</head>
<body>

<h2>P2P Chat Room</h2>

<label>Username (visual): <input type="text" id="username" placeholder="e.g. Alice"></label>
<label>Room ID: <input type="text" id="room" placeholder="e.g. abc123"></label>
<input type="text" id="message" placeholder="Type your message here">
<button id="sendBtn">Send</button>

<div id="chat"></div>

<script>
const workerUrl = "https://sparkling-wildflower-9369.devguywastaken.workers.dev/";

const chatDiv = document.getElementById("chat");
const sendBtn = document.getElementById("sendBtn");
const usernameInput = document.getElementById("username");
const roomInput = document.getElementById("room");
const msgInput = document.getElementById("message");

let pc;
let dc;
let connected = false;
let iceQueue = [];

function append(msg) {
    const p = document.createElement("p");
    p.textContent = msg;
    chatDiv.appendChild(p);
    chatDiv.scrollTop = chatDiv.scrollHeight;
}

async function sendSignal(room, data) {
    try {
        await fetch(workerUrl + "?id=" + room, {
            method:"POST",
            body: JSON.stringify(data)
        });
    } catch(e){ console.error("signal send failed", e); }
}

async function pollSignal(room, username, onMessage) {
    while(!connected) {
        try {
            const res = await fetch(workerUrl + "?id=" + room);
            const text = await res.text();
            //console.log("Raw response from worker:", text);
            let msgs;
            try { msgs = JSON.parse(text); } catch(e){ await new Promise(r => setTimeout(r, 1000)); continue; }

            for(const m of msgs) {
                if(m.from === username) continue; // skip own
                if(m.sdp) {
                    if(!pc.currentRemoteDescription) {
                        await pc.setRemoteDescription(new RTCSessionDescription(m.sdp));
                        if(m.sdp.type === "offer") {
                            const answer = await pc.createAnswer();
                            await pc.setLocalDescription(answer);
                            await sendSignal(room, {sdp: answer, from: username});
                        }
                    }
                }
                if(m.ice) {
                    if(pc.remoteDescription) {
                        await pc.addIceCandidate(new RTCIceCandidate(m.ice));
                    } else {
                        iceQueue.push(m.ice);
                    }
                }
            }
        } catch(e){ console.error(e); }
        await new Promise(r => setTimeout(r, 1000));
    }
}

function autoConnect() {
    const username = usernameInput.value.trim();
    const room = roomInput.value.trim();
    if(!username || !room) return;
    if(pc) return;

    pc = new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]});

    dc = pc.createDataChannel("chat");
    dc.onmessage = e => append(e.data);
    dc.onopen = () => { append("✅ Connected to room!"); connected = true; console.log("Data channel open"); }
    dc.onclose = () => console.log("Data channel closed");
    dc.onerror = e => console.error("Data channel error:", e);

    pc.onicecandidate = e => { if(e.candidate) sendSignal(room, {ice:e.candidate, from: username}); }

    (async () => {
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        await sendSignal(room, {sdp: offer, from: username});

        pollSignal(room, username, msg => {
            // messages handled inside pollSignal
        });

        // add queued ICE candidates after remoteDescription is set
        const checkQueue = setInterval(async () => {
            if(pc.remoteDescription && iceQueue.length) {
                for(const ice of iceQueue) await pc.addIceCandidate(new RTCIceCandidate(ice));
                iceQueue = [];
            }
        }, 500);
    })();
}

usernameInput.addEventListener("input", autoConnect);
roomInput.addEventListener("input", autoConnect);

sendBtn.onclick = () => {
    if(!connected) { append("⚠️ Not connected yet!"); return; }
    const msg = msgInput.value.trim();
    if(!msg) return;
    const username = usernameInput.value || "You";
    dc.send(`${username}: ${msg}`);
    append(`You: ${msg}`);
    msgInput.value = "";
};
</script>

</body>
</html>
