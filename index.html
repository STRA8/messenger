<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>P2P Chat Room</title>
<style>
body {
    font-family: 'Segoe UI', sans-serif;
    background: #f0f2f5;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    padding: 20px;
}
.container {
    background: #fff;
    border-radius: 12px;
    padding: 20px;
    width: 400px;
    box-shadow: 0 8px 16px rgba(0,0,0,0.15);
}
h2 { margin-top:0; text-align:center; color:#333; }
.chat-box {
    border: 1px solid #ccc;
    border-radius: 8px;
    height: 250px;
    overflow-y: auto;
    padding: 10px;
    margin-bottom: 10px;
    background: #fafafa;
}
input, button {
    margin: 5px 0;
    width: 100%;
    padding: 8px;
    border-radius: 6px;
    border: 1px solid #ccc;
    font-size: 14px;
}
button {
    background: #4a90e2;
    color: #fff;
    font-weight: bold;
    cursor: pointer;
}
button:hover { background: #357abd; }
.message { margin-bottom: 10px; }
p { margin: 3px 0; word-wrap: break-word; }
.info { color: #555; font-style: italic; }
.host { color: #2e7d32; font-weight: bold; }
.guest { color: #c62828; font-weight: bold; }
.version { font-size: 12px; text-align:right; color:#888; margin-top:5px; }
</style>
</head>
<body>
<div class="container">
<h2>P2P Chat Room</h2>

<label>Username (visual): <input class="username" type="text" placeholder="e.g. Alice"></label>
<label>Room ID: <input class="room" type="text" placeholder="e.g. abc123"></label>
<input class="message" type="text" placeholder="Type your message here">
<button class="sendBtn">Send</button>

<div class="chat-box"></div>
<div class="version">Version: <span id="version">1.0.0</span></div>
</div>

<script>
const VERSION = "1.0.0"; // update this for each commit
document.getElementById("version").textContent = VERSION;

const workerUrl = "https://sparkling-wildflower-9369.devguywastaken.workers.dev/";

const chatDiv = document.querySelector(".chat-box");
const sendBtn = document.querySelector(".sendBtn");
const usernameInput = document.querySelector(".username");
const roomInput = document.querySelector(".room");
const msgInput = document.querySelector(".message");

let pc, dc, connected=false, isHost=false;

function append(msg, type="") {
    const p = document.createElement("p");
    p.textContent = msg;
    if(type) p.classList.add(type);
    chatDiv.appendChild(p);
    chatDiv.scrollTop = chatDiv.scrollHeight;
}

async function sendSignal(room, data){
    try { await fetch(workerUrl + "?id="+room, {method:"POST", body:JSON.stringify(data)}); }
    catch(e){ append("⚠ Signal send failed: "+e,"info"); }
}

async function pollSignal(room, username, onMessage){
    while(!connected){
        try {
            const res = await fetch(workerUrl+"?id="+room);
            const text = await res.text();
            let msgs;
            try { msgs = JSON.parse(text); } catch(e){ append("⚠ JSON parse failed","info"); await new Promise(r=>setTimeout(r,800)); continue; }

            for(const m of msgs){
                if(m.from !== username) onMessage(m);
            }
        } catch(e){ append("⚠ Poll error: "+e,"info"); }
        await new Promise(r=>setTimeout(r,800));
    }
}

function startConnection(){
    const username = usernameInput.value.trim();
    const room = roomInput.value.trim();
    if(!username || !room) { append("⚠ Enter username and room","info"); return; }
    if(pc) return;

    append("🔹 Starting connection...", "info");

    pc = new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]});

    dc = pc.createDataChannel("chat");
    dc.onmessage = e=>append(e.data);
    dc.onopen = ()=>{ append("✅ Connected to room!"); connected=true; }

    pc.onicecandidate = e=>{ if(e.candidate) sendSignal(room,{ice:e.candidate, from:username}); }

    (async ()=>{
        try{
            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);
            isHost = true;
            append("⭐ You are the host", "host");
            await sendSignal(room,{sdp:offer, from:username});
        } catch(e){ append("⚠ Offer error: "+e,"info"); }

        pollSignal(room, username, async msg=>{
            try{
                if(msg.sdp){
                    if(!pc.currentRemoteDescription){
                        await pc.setRemoteDescription(new RTCSessionDescription(msg.sdp));
                        if(msg.sdp.type==="offer" && !isHost){
                            const answer = await pc.createAnswer();
                            await pc.setLocalDescription(answer);
                            await sendSignal(room,{sdp:answer, from:username});
                            append("⭐ You are the guest", "guest");
                        }
                    }
                }
                if(msg.ice) await pc.addIceCandidate(new RTCIceCandidate(msg.ice));
            } catch(e){ append("⚠ ICE/SDP error: "+e,"info"); }
        });
    })();
}

sendBtn.onclick = ()=>{
    const msg = msgInput.value.trim();
    if(!msg) return;
    if(!dc || dc.readyState!=="open"){ startConnection(); append("⚡ Sending will connect you automatically...","info"); return; }
    const username = usernameInput.value;
    dc.send(`${username}: ${msg}`);
    append(`You: ${msg}`);
    msgInput.value="";
}
</script>
</body>
</html>
