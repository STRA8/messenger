<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Messenger</title>
<style>
body {
  background: #0b0b0d;
  color: white;
  font-family: system-ui, sans-serif;
  display: flex;
  flex-direction: column;
  align-items: center;
  height: 100vh;
  margin: 0;
  padding: 20px;
}

.container {
  display: flex;
  flex-direction: column;
  width: 100%;
  max-width: 600px;
  height: 100%;
  border: 2px solid #222;
  border-radius: 12px;
  background: #141418;
  overflow: hidden;
}

.header {
  padding: 10px;
  background: #1e1e24;
  text-align: center;
  border-bottom: 2px solid #222;
}

.messages {
  flex: 1;
  overflow-y: auto;
  padding: 10px;
}

.message {
  padding: 8px 12px;
  border-radius: 10px;
  margin-bottom: 8px;
  word-wrap: break-word;
}

.message.self { background: #0a84ff; align-self: flex-end; }
.message.remote { background: #333; align-self: flex-start; }
.message.debug { background: #222; color: #aaa; font-size: 0.85em; }

.footer {
  display: flex;
  padding: 10px;
  border-top: 2px solid #222;
  background: #1e1e24;
}

.footer input {
  flex: 1;
  margin-right: 8px;
  padding: 8px;
  border-radius: 8px;
  border: none;
  outline: none;
  background: #2a2a32;
  color: white;
}

.footer button {
  padding: 8px 16px;
  border: none;
  border-radius: 8px;
  background: #0a84ff;
  color: white;
  cursor: pointer;
  font-weight: bold;
}

.footer button:hover {
  background: #0074f0;
}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h2>Messenger v6</h2>
    <div id="status">üî∏ Idle</div>
  </div>

  <div class="messages" id="messages"></div>

  <div class="footer">
    <input id="room" placeholder="Room ID" style="max-width:100px;margin-right:6px;">
    <input id="name" placeholder="Name" style="max-width:100px;margin-right:6px;">
    <input id="message" placeholder="Type a message...">
    <button id="sendBtn">Send</button>
  </div>
</div>

<script>
const workerURL = "https://sparkling-wildflower-9369.devguywastaken.workers.dev/";
let pc, dataChannel;
let room, username;
let connected = false;
let connectingDots = 0;
let connectInterval;
let isHost = false;

const status = document.getElementById('status');
const msgBox = document.getElementById('messages');
const sendBtn = document.getElementById('sendBtn');
const msgInput = document.getElementById('message');

function addMessage(text, type='debug') {
  const div = document.createElement('div');
  div.textContent = text;
  div.className = `message ${type}`;
  msgBox.appendChild(div);
  msgBox.scrollTop = msgBox.scrollHeight;
}

function startConnectingAnimation() {
  connectInterval = setInterval(() => {
    connectingDots = (connectingDots + 1) % 4;
    const dots = '.'.repeat(connectingDots);
    status.textContent = `üü° Connecting${dots}`;
  }, 500);
}

function stopConnectingAnimation(finalText) {
  clearInterval(connectInterval);
  status.textContent = finalText;
}

async function sendToWorker(data) {
  await fetch(`${workerURL}?id=${room}`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data)
  });
}

async function pollWorker() {
  try {
    const res = await fetch(`${workerURL}?id=${room}`);
    const messages = await res.json();
    if (!Array.isArray(messages)) return;
    for (const msg of messages) {
      if (msg.from === username) continue;
      handleSignal(msg);
    }
  } catch (err) {
    addMessage("Polling error: " + err, "debug");
  }
}

function startPolling() {
  setInterval(pollWorker, 1000);
}

async function connect() {
  room = document.getElementById('room').value.trim();
  username = document.getElementById('name').value.trim() || "guest";
  if (!room) return addMessage("‚ö†Ô∏è Enter a room ID first", "debug");

  addMessage(`üîπ Starting connection as ${username}`, "debug");
  startConnectingAnimation();

  pc = new RTCPeerConnection();
  pc.onicecandidate = e => {
    if (e.candidate) sendToWorker({ ice: e.candidate, from: username });
  };
  pc.ondatachannel = e => {
    dataChannel = e.channel;
    setupDataChannel();
  };

  // check if anyone's in the room yet
  const res = await fetch(`${workerURL}?id=${room}`);
  const existing = await res.json();
  if (existing.length === 0) {
    isHost = true;
    dataChannel = pc.createDataChannel("chat");
    setupDataChannel();
    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
    await sendToWorker({ sdp: offer, from: username });
    addMessage("üü¢ You are host", "debug");
  } else {
    isHost = false;
    addMessage("üü† You are guest", "debug");
    for (const msg of existing) handleSignal(msg);
  }

  startPolling();
}

async function handleSignal(data) {
  try {
    if (data.sdp) {
      await pc.setRemoteDescription(new RTCSessionDescription(data.sdp));
      if (data.sdp.type === "offer") {
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        await sendToWorker({ sdp: answer, from: username });
        addMessage("üì° Sent answer", "debug");
      }
    } else if (data.ice) {
      if (!pc.remoteDescription) return addMessage("‚ö†Ô∏è ICE before remoteDescription", "debug");
      await pc.addIceCandidate(data.ice);
    }
  } catch (err) {
    addMessage("‚ö†Ô∏è Signal error: " + err.message, "debug");
  }
}

function setupDataChannel() {
  dataChannel.onopen = () => {
    connected = true;
    stopConnectingAnimation("üü¢ Connected");
    addMessage("‚úÖ Data channel open!", "debug");
  };
  dataChannel.onmessage = e => {
    addMessage(e.data, "remote");
  };
  dataChannel.onclose = () => {
    connected = false;
    stopConnectingAnimation("üî¥ Disconnected");
  };
}

sendBtn.onclick = async () => {
  if (!connected && !pc) {
    await connect();
    return;
  }
  const text = msgInput.value.trim();
  if (!text) return;
  if (connected && dataChannel?.readyState === "open") {
    dataChannel.send(`${username}: ${text}`);
    addMessage(`${username}: ${text}`, "self");
    msgInput.value = "";
  } else {
    addMessage("‚ö†Ô∏è Not connected yet", "debug");
  }
};
</script>
</body>
</html>
