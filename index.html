<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Messenger v7</title>
  <style>
    body { font-family: sans-serif; background:#0e0e0e; color:white; display:flex; flex-direction:column; align-items:center; padding:20px; }
    .chat { width:90%; max-width:500px; border:1px solid #444; border-radius:10px; padding:10px; background:#1a1a1a; }
    .messages { height:300px; overflow-y:auto; border:1px solid #333; border-radius:6px; padding:5px; background:#111; }
    .msg { margin:4px 0; padding:6px 10px; border-radius:6px; }
    .msg.you { background:#2a2a2a; text-align:right; }
    .msg.other { background:#333; text-align:left; }
    .msg.debug { color:#888; font-size:0.9em; }
    .bottom { display:flex; gap:6px; margin-top:6px; }
    .input { flex:1; padding:6px; border:none; border-radius:6px; background:#222; color:white; }
    .button { padding:6px 10px; background:#3a3a3a; border:none; border-radius:6px; cursor:pointer; color:white; }
    .config { margin-bottom:10px; display:flex; gap:5px; flex-wrap:wrap; }
  </style>
</head>
<body>

  <div class="chat">
    <div class="config">
      <input class="input room" placeholder="Room ID">
      <input class="input name" placeholder="Username">
      <select class="input role">
        <option value="host">Host</option>
        <option value="guest">Guest</option>
      </select>
      <button class="button connect">Connect</button>
    </div>

    <div class="messages"></div>

    <div class="bottom">
      <input class="input message" placeholder="Type message...">
      <button class="button send">Send</button>
    </div>
  </div>

  <div style="margin-top:10px; color:#777;">Messenger v7</div>

  <script>
    const workerURL = 'https://sparkling-wildflower-9369.devguywastaken.workers.dev/';
    const messagesDiv = document.querySelector('.messages');
    const roomInput = document.querySelector('.room');
    const nameInput = document.querySelector('.name');
    const msgInput = document.querySelector('.message');
    const sendBtn = document.querySelector('.send');
    const connectBtn = document.querySelector('.connect');
    const roleSelect = document.querySelector('.role');

    let pc, channel, room, username, role, connected = false;

    function log(text, type='debug') {
      const div = document.createElement('div');
      div.className = `msg ${type}`;
      div.textContent = text;
      messagesDiv.appendChild(div);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    connectBtn.onclick = () => startConnection();
    sendBtn.onclick = () => sendMessage();

    async function startConnection() {
      room = roomInput.value.trim();
      username = nameInput.value.trim() || 'guest';
      role = roleSelect.value;
      if (!room) return log('‚ö†Ô∏è enter a room ID first');
      log(`üîπ Starting as ${role} (${username})...`);

      pc = new RTCPeerConnection();
      pc.onicecandidate = async e => {
        if (e.candidate) await sendSignal({ ice: e.candidate });
      };
      pc.ondatachannel = e => {
        channel = e.channel;
        setupChannel();
      };

      if (role === 'host') {
        channel = pc.createDataChannel('chat');
        setupChannel();
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        await sendSignal({ sdp: offer });
      }

      pollSignal();
    }

    function setupChannel() {
      channel.onopen = () => { connected = true; log('‚úÖ connected'); };
      channel.onmessage = e => log(`${e.data}`, 'other');
      channel.onclose = () => log('‚ùå disconnected');
    }

    async function sendMessage() {
      if (!connected) return log('not connected yet');
      const msg = msgInput.value.trim();
      if (!msg) return;
      channel.send(username + ': ' + msg);
      log('you: ' + msg, 'you');
      msgInput.value = '';
    }

    async function sendSignal(body) {
      await fetch(`${workerURL}?id=${room}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ...body, from: username })
      });
    }

    async function pollSignal() {
      try {
        const res = await fetch(`${workerURL}?id=${room}`);
        const signals = await res.json();
        if (signals.length) log(`üì° got ${signals.length} signals`);
        for (const sig of signals) {
          if (sig.from === username) continue;
          if (sig.sdp) {
            await pc.setRemoteDescription(new RTCSessionDescription(sig.sdp));
            if (sig.sdp.type === 'offer') {
              const answer = await pc.createAnswer();
              await pc.setLocalDescription(answer);
              await sendSignal({ sdp: answer });
            }
          } else if (sig.ice) {
            if (!pc.remoteDescription) {
              log('‚ö†Ô∏è remoteDescription not set yet, retrying soon');
            } else {
              try {
                await pc.addIceCandidate(sig.ice);
              } catch (err) {
                log('‚ö†Ô∏è addIceCandidate failed: ' + err);
              }
            }
          }
        }
      } catch (err) {
        log('polling error: ' + err);
      }
      setTimeout(pollSignal, 1000);
    }
  </script>

</body>
</html>
