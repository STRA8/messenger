<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>STR8 Messenger v9</title>
<style>
body {
  font-family: monospace;
  background: #0a0a0a;
  color: #e0e0e0;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 100vh;
}
#chat {
  width: 90%;
  max-width: 600px;
  height: 70vh;
  border: 1px solid #333;
  padding: 10px;
  overflow-y: auto;
  background: #111;
  margin-bottom: 10px;
}
#controls {
  display: flex;
  gap: 5px;
}
input, button {
  background: #222;
  color: white;
  border: 1px solid #333;
  padding: 5px;
}
button:hover { background: #333; }
</style>
</head>
<body>
<h2>STR8 Messenger v9</h2>
<div id="chat"></div>

<div id="controls">
  <input id="roomId" placeholder="Room ID">
  <input id="username" placeholder="Username">
  <select id="role">
    <option value="auto">Auto</option>
    <option value="host">Host</option>
    <option value="guest">Guest</option>
  </select>
  <button id="connectBtn">Connect</button>
</div>

<div id="sendArea" style="margin-top:10px;">
  <input id="msgBox" placeholder="Type a message" style="width:70%;">
  <button id="sendBtn">Send</button>
</div>

<script>
const chat = document.getElementById('chat')
function log(msg) {
  const div = document.createElement('div')
  div.textContent = msg
  chat.appendChild(div)
  chat.scrollTop = chat.scrollHeight
}

let pc, channel
let role = "auto"
let room = ""
let name = ""

document.getElementById("connectBtn").onclick = async () => {
  room = document.getElementById("roomId").value.trim()
  name = document.getElementById("username").value.trim() || "guest"
  role = document.getElementById("role").value
  log(`ðŸ”¹ Connecting to room [${room}] as ${name} (${role})`)
  startConnection()
}

document.getElementById("sendBtn").onclick = () => {
  if (!channel || channel.readyState !== "open") return log("âš ï¸ Not connected yet")
  const msg = document.getElementById("msgBox").value
  if (!msg) return
  channel.send(JSON.stringify({ from: name, text: msg }))
  log(`ðŸŸ¢ You: ${msg}`)
  document.getElementById("msgBox").value = ""
}

async function startConnection() {
  pc = new RTCPeerConnection()
  pc.onicecandidate = e => {
    if (e.candidate) fetch(`https://signal-server.fly.dev/${room}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ type: "ice", candidate: e.candidate, from: role })
    })
  }

  pc.ondatachannel = e => {
    channel = e.channel
    setupChannel()
    log("ðŸŸ¢ Data channel received.")
  }

  if (role === "host" || role === "auto") {
    log("ðŸŸ© Acting as host.")
    channel = pc.createDataChannel("chat")
    setupChannel()

    const offer = await pc.createOffer()
    await pc.setLocalDescription(offer)
    log("ðŸ“¤ Sending offer...")
    await fetch(`https://signal-server.fly.dev/${room}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ type: "offer", sdp: offer, from: "host" })
    })
  } else {
    log("ðŸŸ¦ Acting as guest.")
  }

  poll()
}

function setupChannel() {
  channel.onopen = () => log("âœ… Channel open! You can chat now.")
  channel.onmessage = e => {
    const msg = JSON.parse(e.data)
    log(`ðŸ’¬ ${msg.from}: ${msg.text}`)
  }
  channel.onclose = () => log("âŒ Channel closed.")
}

async function poll() {
  while (true) {
    try {
      const res = await fetch(`https://signal-server.fly.dev/${room}`)
      const txt = await res.text()
      if (!txt || txt === "ok") continue
      log(`ðŸ“¥ Got signal: ${txt}`)
      const data = JSON.parse(txt)
      if (data.type === "offer" && role !== "host") {
        log("ðŸ“¥ Received offer -> sending answer.")
        await pc.setRemoteDescription(new RTCSessionDescription(data.sdp))
        const answer = await pc.createAnswer()
        await pc.setLocalDescription(answer)
        await fetch(`https://signal-server.fly.dev/${room}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ type: "answer", sdp: answer, from: "guest" })
        })
      } else if (data.type === "answer" && role === "host") {
        log("ðŸ“¥ Received answer -> connecting.")
        await pc.setRemoteDescription(new RTCSessionDescription(data.sdp))
      } else if (data.type === "ice" && data.candidate) {
        await pc.addIceCandidate(new RTCIceCandidate(data.candidate))
        log("ðŸ§Š Added ICE candidate.")
      }
    } catch (err) {
      log("âš ï¸ Poll error: " + err)
    }
    await new Promise(r => setTimeout(r, 2000))
  }
}
</script>
</body>
</html>
