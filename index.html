<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>P2P Chat via Cloudflare Worker</title>
<style>
body { font-family: sans-serif; margin: 20px; }
#chat { border: 1px solid #ccc; height: 250px; overflow-y: auto; padding: 10px; margin-bottom: 10px; }
input, button { margin: 5px 0; width: 100%; }
</style>
</head>
<body>

<h2>P2P Chat</h2>

<label>Your ID: <input type="text" id="userId" placeholder="e.g. alice"></label>
<label>Peer ID: <input type="text" id="peerId" placeholder="e.g. bob"></label>
<input type="text" id="message" placeholder="Type your message here">
<button id="connectBtn">Connect</button>
<button id="sendBtn">Send</button>

<div id="chat"></div>

<script>
const workerUrl = "https://sparkling-wildflower-9369.devguywastaken.workers.dev/";

const chatDiv = document.getElementById("chat");
const connectBtn = document.getElementById("connectBtn");
const sendBtn = document.getElementById("sendBtn");
const userIdInput = document.getElementById("userId");
const peerIdInput = document.getElementById("peerId");
const msgInput = document.getElementById("message");

let pc;
let dc;
let connected = false;

function append(msg) {
    const p = document.createElement("p");
    p.textContent = msg;
    chatDiv.appendChild(p);
    chatDiv.scrollTop = chatDiv.scrollHeight;
}

// send signaling message to worker
async function sendSignal(id, data) {
    await fetch(workerUrl + "?id=" + id, {method:"POST", body:JSON.stringify(data)});
}

// poll worker for messages
async function pollSignal(id, onMessage) {
    while(!connected) {
        try {
            const res = await fetch(workerUrl + "?id=" + id);
            const msgs = await res.json();
            for(const m of msgs) onMessage(JSON.parse(m));
        } catch(e) { console.error(e) }
        await new Promise(r => setTimeout(r, 1000));
    }
}

// connect to peer
async function connect() {
    const userId = userIdInput.value.trim();
    const peerId = peerIdInput.value.trim();
    if(!userId || !peerId) return alert("Enter both IDs!");

    pc = new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]});

    dc = pc.createDataChannel("chat");
    dc.onmessage = e => append(e.data);
    dc.onopen = () => { append("âœ… Connected to peer!"); connected = true; }

    pc.onicecandidate = e => { if(e.candidate) sendSignal(peerId, {ice:e.candidate}); }

    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
    await sendSignal(peerId, {sdp: offer});

    pollSignal(userId, async msg => {
        if(msg.sdp) {
            await pc.setRemoteDescription(new RTCSessionDescription(msg.sdp));
            if(msg.sdp.type === "offer") {
                const answer = await pc.createAnswer();
                await pc.setLocalDescription(answer);
                await sendSignal(peerId, {sdp: answer});
            }
        }
        if(msg.ice) await pc.addIceCandidate(new RTCIceCandidate(msg.ice));
    });
}

// connect button
connectBtn.onclick = connect;

// send chat message
sendBtn.onclick = () => {
    const msg = msgInput.value.trim();
    if(!msg || !dc || dc.readyState!=="open") return;
    const from = userIdInput.value || "You";
    dc.send(`${from}: ${msg}`);
    append(`You: ${msg}`);
    msgInput.value = "";
}
</script>

</body>
</html>
