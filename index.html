<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>P2P Chat Room</title>
<style>
body { font-family: sans-serif; margin: 20px; }
#version { font-size: 0.9em; color: gray; margin-bottom: 10px; }
#chat { border: 1px solid #ccc; height: 300px; overflow-y: auto; padding: 10px; margin-bottom: 10px; }
input, button { margin: 5px 0; width: 100%; }
.system { color: blue; font-size: 0.9em; }
.message { color: black; }
</style>
</head>
<body>

<h2>P2P Chat Room</h2>
<p id="version" class="system">Version: loading...</p>

<label>Username (visual): <input type="text" id="username" placeholder="Your name"></label>
<label>Room ID: <input type="text" id="room" placeholder="Room ID"></label>
<input type="text" id="message" placeholder="Type your message here">
<button id="sendBtn">Send</button>

<div id="chat"></div>

<script>
const workerUrl = "https://sparkling-wildflower-9369.devguywastaken.workers.dev/";

const chatDiv = document.getElementById("chat");
const sendBtn = document.getElementById("sendBtn");
const usernameInput = document.getElementById("username");
const roomInput = document.getElementById("room");
const msgInput = document.getElementById("message");

let pc;
let dc;
let connected = false;

function append(msg, type="message") {
    const p = document.createElement("p");
    p.textContent = msg;
    p.className = type;
    chatDiv.appendChild(p);
    chatDiv.scrollTop = chatDiv.scrollHeight;
}

// GitHub commit version
async function fetchVersion() {
    try {
        const res = await fetch("https://api.github.com/repos/STRA8/messenger/commits/main");
        const data = await res.json();
        const sha = data.sha.slice(0,7);
        document.getElementById("version").textContent = "Version: commit " + sha;
    } catch(e) {
        document.getElementById("version").textContent = "Version: unknown";
    }
}
fetchVersion();

async function sendSignal(room, data) {
    try { await fetch(workerUrl + "?id=" + room, {method:"POST", body:JSON.stringify(data)}); }
    catch(e){ append("Signal send failed: " + e.message, "system"); }
}

async function pollSignal(room, username) {
    while(!connected) {
        try {
            const res = await fetch(workerUrl + "?id=" + room);
            const text = await res.text();
            let msgs = [];
            try { msgs = JSON.parse(text); } catch(e){ append("Invalid JSON from worker", "system"); }

            for(const m of msgs) {
                if(m.from !== username) {
                    if(m.sdp) {
                        append(`Received SDP from ${m.from} (${m.sdp.type})`, "system");
                        if(!pc.currentRemoteDescription) {
                            await pc.setRemoteDescription(new RTCSessionDescription(m.sdp));
                            if(m.sdp.type === "offer") {
                                const answer = await pc.createAnswer();
                                await pc.setLocalDescription(answer);
                                await sendSignal(room, {sdp: answer, from: username});
                                append("Sent answer back", "system");
                            }
                        }
                    }
                    if(m.ice) {
                        append(`Received ICE from ${m.from}`, "system");
                        await pc.addIceCandidate(new RTCIceCandidate(m.ice));
                    }
                }
            }
        } catch(e){ append("Polling error: " + e.message, "system"); }
        await new Promise(r=>setTimeout(r, 1000));
    }
}

async function startConnection() {
    if(pc) return;
    const username = usernameInput.value.trim();
    const room = roomInput.value.trim();
    if(!username || !room) {
        append("Enter username and room ID first", "system");
        return;
    }

    append("ðŸ”¹ Starting connection...", "system");

    pc = new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]});
    dc = pc.createDataChannel("chat");

    dc.onopen = () => { append("âœ… Connected!", "system"); connected = true; }
    dc.onmessage = e => append(e.data);

    pc.onicecandidate = e => { if(e.candidate) sendSignal(room, {ice:e.candidate, from: username}); }

    // check room to see if already has messages â†’ if empty, become host
    try {
        const res = await fetch(workerUrl + "?id=" + room);
        const text = await res.text();
        let msgs = [];
        try { msgs = JSON.parse(text); } catch(e){ append("Invalid JSON from worker", "system"); }

        if(msgs.length === 0) {
            // Host â†’ create offer
            append("You are the host (first in room)", "system");
            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);
            await sendSignal(room, {sdp: offer, from: username});
        } else {
            append("You are guest (waiting for offer)", "system");
        }
    } catch(e){ append("Error checking room: " + e.message, "system"); }

    pollSignal(room, username);
}

sendBtn.onclick = async () => {
    if(!pc) await startConnection();

    const msg = msgInput.value.trim();
    if(!msg || !dc || dc.readyState !== "open") return;

    const username = usernameInput.value;
    dc.send(`${username}: ${msg}`);
    append(`${username}: ${msg}`);
    msgInput.value = "";
}
</script>

</body>
</html>
